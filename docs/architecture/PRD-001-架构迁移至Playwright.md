# auto_geo 架构迁移至Playwright - 产品需求文档

## 一、需求概述

### 1.1 需求背景
当前auto_geo项目使用Electron + BitBrowser API实现多平台文章发布功能。但由于BitBrowser的局限性，需要迁移到更灵活的Playwright自动化方案，实现真正的全自动文章发布。

### 1.2 目标用户
- 内容创作者：需要同时在多个平台发布文章
- 运营人员：管理多个自媒体账号

### 1.3 核心价值
- **真正自动化**：从打开浏览器到发布文章全程自动，无需人工干预
- **跨平台支持**：统一管理知乎、百家号、搜狐号、头条号、公众号
- **账号安全**：每个账号独立浏览器环境，避免关联

## 二、架构变更

### 2.1 现有架构
```
┌─────────────────────────────────────────┐
│            Electron 前端                 │
├─────────────────────────────────────────┤
│         IPC 通信层                       │
├─────────────────────────────────────────┤
│      BitBrowser 服务 (Node.js)          │
│         ┌─────────────────┐             │
│         │ BitBrowser API  │             │
│         └─────────────────┘             │
└─────────────────────────────────────────┘
```

### 2.2 目标架构
```
┌─────────────────────────────────────────┐
│            Electron 前端                 │
├─────────────────────────────────────────┤
│         IPC / HTTP 通信层                │
├─────────────────────────────────────────┤
│          Python 后端服务                 │
│  ┌─────────────────────────────┐        │
│  │      FastAPI / Flask        │        │
│  ├─────────────────────────────┤        │
│  │       Playwright            │        │
│  │  ┌───┬───┬───┬───┬───┐     │        │
│  │  │知乎│百家│搜狐│头条│公众号│     │        │
│  │  └───┴───┴───┴───┴───┘     │        │
│  └─────────────────────────────┘        │
└─────────────────────────────────────────┘
```

### 2.3 技术栈对比

| 维度 | BitBrowser方案 | Playwright方案 |
|-----|---------------|---------------|
| 编程语言 | Node.js | Python |
| 浏览器管理 | 依赖第三方软件 | 完全自主控制 |
| 自动化能力 | 仅能打开浏览器 | 完整页面操作 |
| 隐私隔离 | 比特浏览器配置 | Playwright Context |
| 跨平台 | Windows only | 全平台支持 |

## 三、功能需求

### 3.1 用户故事
```
作为 内容创作者
我想要 保存多个平台的登录状态并一键发布文章
以便于 节省时间，提高分发效率
```

### 3.2 功能清单

| 功能点 | 优先级 | 描述 | 备注 |
|-------|-------|------|-----|
| Python后端服务 | P0 | 启动FastAPI/Flask服务 | 提供HTTP API |
| 手动登录授权 | P0 | 打开浏览器让用户手动登录 | 保存cookies |
| Cookie持久化 | P0 | 将登录状态加密保存到数据库 | 支持多账号 |
| 文章自动发布 | P0 | 读取文章内容自动填充并发布 | 全流程自动 |
| 多平台适配 | P0 | 支持5大平台的发布流程 | 各平台独立模块 |
| 发布状态反馈 | P1 | 实时反馈发布进度和结果 | WebSocket通知 |
| 失败重试 | P1 | 发布失败自动重试 | 可配置重试次数 |
| 发布记录 | P1 | 记录每篇文章的发布状态 | 历史查询 |
| 定时发布 | P2 | 支持定时自动发布 | 后续版本 |
| 图片上传 | P2 | 支持文章中图片自动上传 | 各平台处理不同 |

### 3.3 使用流程

#### 流程1：账号授权（首次）
```
用户操作步骤：
1. 进入"账号管理"页面
2. 点击"添加账号"按钮
3. 选择平台（知乎/百家号/搜狐号/头条号/公众号）
4. 输入账号名称（备注）
5. 点击"去授权"按钮
6. 系统打开独立浏览器窗口，跳转到平台登录页
7. 用户手动完成登录（扫码/密码/验证码）
8. 系统检测登录成功，提取cookies
9. 加密保存cookies到数据库
10. 显示"授权成功"
```

#### 流程2：文章自动发布
```
用户操作步骤：
1. 进入"文章编辑"页面
2. 创建/编辑文章内容
3. 保存文章
4. 进入"批量发布"页面
5. 选择要发布的文章
6. 勾选目标账号
7. 点击"开始发布"
8. 系统自动执行：
   a. 为每个账号创建独立浏览器上下文
   b. 加载已保存的cookies
   c. 打开平台创作页面
   d. 填充标题、正文
   e. 处理图片上传（如果有）
   f. 点击发布按钮
   g. 等待发布结果
9. 显示发布进度和结果
10. 保存发布记录
```

## 四、数据需求

### 4.1 数据实体扩展

#### accounts 表（扩展字段）
| 字段 | 类型 | 说明 | 新增 |
|-----|------|------|-----|
| id | Integer | 主键 | - |
| platform | String | 平台名称 | - |
| account_name | String | 账号备注 | - |
| username | String | 登录账号 | - |
| cookies | Text/JSON | 加密的cookies | ✅ 新增 |
| user_agent | String | 浏览器UA | ✅ 新增 |
| storage_state | Text/JSON | 本地存储状态 | ✅ 新增 |
| last_auth_time | DateTime | 最后授权时间 | ✅ 新增 |
| status | Integer | 账号状态 | - |
| remark | String | 备注 | - |

#### publish_records 表（扩展字段）
| 字段 | 类型 | 说明 | 新增 |
|-----|------|------|-----|
| id | Integer | 主键 | - |
| article_id | Integer | 文章ID | - |
| account_id | Integer | 账号ID | - |
| publish_status | Integer | 发布状态 | - |
| error_msg | Text | 错误信息 | - |
| platform_url | String | 发布后的文章链接 | ✅ 新增 |
| published_at | DateTime | 实际发布时间 | ✅ 新增 |
| retry_count | Integer | 重试次数 | ✅ 新增 |
| created_at | DateTime | 创建时间 | - |

### 4.2 数据关系
```
accounts (1) ────< (N) publish_records >───── (N) articles
```

## 五、非功能需求

### 5.1 性能要求
- [ ] Python后端启动时间 < 3秒
- [ ] 单次发布耗时 < 30秒
- [ ] 支持至少5个账号同时发布
- [ ] Cookies加密存储，解密耗时 < 100ms

### 5.2 安全要求
- [ ] Cookies使用AES-256加密存储
- [ ] 敏感信息不打印到日志
- [ ] 账号状态失效自动检测
- [ ] 支持手动清除账号登录状态

### 5.3 兼容性要求
- [ ] Windows 10/11
- [ ] Python 3.10+
- [ ] Chromium/Chrome/Edge浏览器
- [ ] Electron最新版

## 六、平台适配分析

### 6.1 各平台登录方式
| 平台 | 登录方式 | 是否扫码 | 特殊处理 |
|-----|---------|---------|---------|
| 知乎 | 密码/扫码 | 是 | 二维码轮询检测 |
| 百家号 | 扫码为主 | 是 | 必须扫码 |
| 搜狐号 | 密码/扫码 | 是 | 支持密码登录 |
| 头条号 | 扫码为主 | 是 | 必须扫码 |
| 公众号 | 扫码唯一 | 是 | 必须手机扫码 |

### 6.2 各平台发布入口
| 平台 | 发布入口URL | 标题选择器 | 正文选择器 | 发布按钮 |
|-----|-------------|-----------|-----------|---------|
| 知乎 | https://zhuanlan.zhihu.com/write | `.Input` | `.public-DraftStyleDefault-block` | `.PublishButton` |
| 百家号 | https://baijiahao.baidu.com/builder/rc/edit/index | `[placeholder*="标题"]` | `.editor-body` | `.submit-btn` |
| 搜狐号 | https://mp.sohu.com/upload/article | `#title` | `#ueditor_textarea` | `.publish-btn` |
| 头条号 | https://mp.toutiao.com/profile/article/article_edit | `[field="title"]` | `.article-container` | `.submit-btn` |
| 公众号 | 需定位特定元素 | 待确认 | 待确认 | 待确认 |

## 七、边界与约束

### 7.1 功能边界
**包含**：
- ✅ 5大平台账号授权和发布
- ✅ 全自动文章发布
- ✅ Cookies加密存储
- ✅ 发布状态实时反馈

**不包含**：
- ❌ 评论管理
- ❌ 数据统计
- ❌ 内容审核
- ❌ 视频发布

**后续版本**：
- 🔲 定时发布
- 🔲 图片自动上传
- 🔲 草稿箱管理
- 🔲 多人协作

### 7.2 技术约束
- 前端保持Electron不变
- 后端使用Python独立进程
- 通信使用HTTP/WebSocket
- 数据库继续用SQLite（sql.js或Python sqlite3）

## 八、验收标准

### 8.1 功能验收
- [ ] Python后端能正常启动并响应API
- [ ] 能打开浏览器让用户手动登录
- [ ] Cookies能正确加密保存和加载
- [ ] 能自动填充文章内容并发布
- [ ] 发布状态能实时反馈给前端
- [ ] 5个平台都能正常发布

### 8.2 体验验收
- [ ] 授权流程顺畅，用户操作不超过3步
- [ ] 发布进度实时可见
- [ ] 错误提示清晰明确
- [ ] 失败后能自动重试或提示手动处理

## 九、风险与依赖

### 9.1 技术风险
| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| 平台反爬虫策略变化 | 高 | 选择器需定期维护 |
| Cookies失效 | 中 | 自动检测并提示重新授权 |
| 并发发布冲突 | 低 | 队列化处理 |
| 公众号登录复杂 | 中 | 可能需要特殊处理 |

### 9.2 外部依赖
- Playwright Python库
- Chromium浏览器
- 平台登录页面结构

## 十、实施计划

### 10.1 开发阶段

#### 第一阶段：基础架构（1-2天）
- [ ] 搭建Python后端服务（FastAPI/Flask）
- [ ] 实现Electron与Python的通信机制
- [ ] 设计数据库新表结构

#### 第二阶段：账号授权（2-3天）
- [ ] 实现Playwright浏览器管理
- [ ] 实现各平台登录页面打开
- [ ] 实现Cookies提取和加密存储
- [ ] 实现登录状态检测

#### 第三阶段：文章发布（3-5天）
- [ ] 实现知乎自动发布
- [ ] 实现百家号自动发布
- [ ] 实现搜狐号自动发布
- [ ] 实现头条号自动发布
- [ ] 实现公众号自动发布

#### 第四阶段：前端适配（1-2天）
- [ ] 修改发布页面UI
- [ ] 添加实时进度显示
- [ ] 添加授权流程界面

#### 第五阶段：测试优化（1-2天）
- [ ] 各平台发布测试
- [ ] 异常处理优化
- [ ] 性能优化

### 10.2 预计工作量
- **总工作量**：8-14天
- **复杂度**：复杂
- **关键路径**：平台适配

## 十一、附录

### 11.1 参考文档
- Playwright Python文档：https://playwright.dev/python/
- 知乎专栏发布：https://zhuanlan.zhihu.com/
- 百家号平台：https://baijiahao.baidu.com/
- 搜狐号平台：https://mp.sohu.com/
- 头条号平台：https://mp.toutiao.com/
- 公众号平台：https://mp.weixin.qq.com/

### 11.2 变更记录
| 日期 | 版本 | 变更内容 | 变更人 |
|------|------|---------|-------|
| 2025-01-08 | v1.0 | 初始版本 | Claude(老王模式) |

---

**需求分析完成！请主控Agent审批后，安排架构设计Agent进行技术方案设计。**
